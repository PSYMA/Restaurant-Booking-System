<div class="bg-white p-0">
    <%= render "shared/navbar" %>    
    <div class="container py-5">  
        <div class="text-center">
            <h5 class="section-title ff-secondary text-center text-primary fw-normal">Reservation Section</h5>
            <h1 class=" ">Restaurant Bookings</h1>
        </div>  
        
        <% if Current.user.role == Roles::ADMIN %> 
            <div class="panel panel-default" >   
                <%= turbo_frame_tag "admin_bookings" do %> 
                    <div class="panel-table">
                        <div class="table-responsive">
                            <div class="pull-right mb-2">
                                <%= search_form_for @q, url: bookings_path do |form|%> 
                                    <div class="text-center mt-1">
                                        <%= form.search_field :first_name_cont %>
                                        <%= form.submit %>
                                    </div>
                                <% end %>
                            </div>
                            
                            <table class="table table-striped table-bordered">
                                <thead>
                                    <tr class="text-center"> 
                                        <th>NAME</th>
                                        <th>DATE</th> 
                                        <th>STATUS</th> 
                                        <th>PRODUCTS</th>
                                        <th>TOTAL PRICE</th>
                                        <th><em class="fa fa-cog"></em></th>
                                    </tr> 
                                </thead>
                                <tbody> 
                                    <% @reservations.each do |reservation|%>  
                                        <tr class="text-center align-middle fw-bold"> 
                                            <td>
                                                <h6>
                                                    <% user = User.find(reservation.user_id) %>
                                                    <%= user.first_name %> <%= user.last_name %>
                                                </h6>
                                                
                                            </td>
                                            <td> <h6><%= reservation.date %></h6> </td> 
                                            <td>
                                                <% if reservation.status == Status::PENDING %>
                                                    <h6 class="text-warning">PENDING</h6>
                                                <% elsif reservation.status == Status::CONFIRMED %>
                                                    <h6 class="text-success">CONFIRMED</h6>
                                                <% elsif reservation.status == Status::CANCELED %>
                                                    <h6 class="text-danger">CANCELED</h6>
                                                <% elsif reservation.status == Status::DELETED %>
                                                    <h6 class="text-danger">DELETED</h6>
                                                <% else %>
                                                    <h6 class="text-danger">DECLINE</h6>
                                                <% end %>
                                            </td> 
                                            <td>  
                                                <button class="btn btn-info fw-bolder" data-bs-toggle="modal" data-bs-target="#modal-<%= reservation.id %>">
                                                    view products
                                                </button>  
                                                <%= render "modal", id: "modal-#{reservation.id}", orders: reservation.order.order_products %>   
                                            </td>
                                            <td><h6><%= reservation.order.total_amount %> $</h6></td>
                                            <td class="text-center"> 
                                                <div class="btn-group">   
                                                    <%= form_with url: bookings_path, data: { turbo: true }, method: :patch do |form|%>
                                                        <%= form.hidden_field :reservation_id, value: reservation.id %>
                                                        <button class="btn btn-success" style="margin-right: .5em">
                                                            <i class="fa fa-check"></i>
                                                        </button>
                                                    <% end %> 
                                                    <%= form_with url: bookings_path, data: { turbo: true }, method: :put do |form|%>
                                                        <%= form.hidden_field :reservation_id, value: reservation.id %>
                                                        <button class="btn btn-danger">
                                                            <i class="fa fa-times"></i>
                                                        </button>
                                                    <% end %>  
                                                </div>
                                            </td>
                                        </tr>
                                    <% end %> 
                                </tbody>
                            </table> 
                        </div>
                    </div>  

                    <div class="digg_pagination">   
                        <div class="pull-right container">
                            <%= will_paginate @reservations, renderer: WillPaginate::ActionView::LinkRenderer  %>  
                        </div> 
                    </div>
                    <%= javascript_include_tag "js/bookings.js", "data-turbo-track": "reload", defer: true %> 
                <% end %>
            </div> 
        <% else %>  
            <% Current.user.reservations.reverse.each do |reservation| %>
                <% if reservation.status == Status::CANCELED || reservation.status == Status::DELETED %>
                    <div class="container disabled">
                <% else %>
                    <div class="container">
                <% end %>
                    <div class="panel panel-default panel-table mb-5 card container" >
                        <%= turbo_frame_tag "customer_bookings" do %>   
                            <div class="panel-table table-responsive"> 
                                <div class="d-inline fw-bold fs-5">  
                                    <% if reservation.status == Status::PENDING %> 
                                        <span class="text-warning d-block">Date: <%= reservation.date%></span> 
                                        <span class="text-warning">Status: PENDING</span> 
                                    <% elsif reservation.status == Status::CONFIRMED %>
                                        <span class="text-success d-block">Date: <%= reservation.date%></span> 
                                        <span class="text-success">Status: CONFIRMED</span>
                                    <% elsif reservation.status == Status::CANCELED %>
                                        <span class="text-secondary d-block">Date: <%= reservation.date%></span> 
                                        <span class="text-secondary">Status: CANCELED</span>
                                    <% elsif reservation.status == Status::DELETED %>
                                        <span class="text-secondary d-block">Date: <%= reservation.date%></span> 
                                        <span class="text-secondary">Status: DELETED</span>
                                    <% else %>
                                        <span class="text-secondary d-block">Date: <%= reservation.date%></span> 
                                        <span class="text-secondary">Status: DECLINE</span>
                                    <% end %>   
                                </div>

                                <div class="pull-right mb-1"> 
                                    <%= form_with url: bookings_cancel_path, class: "d-inline", data: { turbo: false }, method: :patch do |form|%> 
                                        <%= form.hidden_field :reservation_id, value: reservation.id %>
                                        <button class="btn btn-warning" data-toggle="tooltip" data-placement="bottom" title="CANCEL RESERVATION">
                                            <i class="fa fa-ban"></i>
                                        </button>
                                    <% end %> 
                                    <%= form_with url: bookings_path, class: "d-inline", data: { turbo: false }, method: :delete do |form|%> 
                                        <%= form.hidden_field :reservation_id, value: reservation.id %>
                                        <button class="btn btn-danger" data-toggle="tooltip" data-placement="bottom" title="DELETE RESERVATION">
                                            <i class="fa fa-trash-o"></i>
                                        </button>
                                    <% end %>  
                                </div>
                         
                                <table class="table table-striped table-bordered"> 
                                    <thead>
                                        <tr class="text-center"> 
                                            <th><i class="fa fa-picture-o" aria-hidden="true"></i></th>
                                            <th>NAME</th> 
                                            <th>PRICE</th> 
                                        </tr> 
                                    </thead>
                                    <tbody>   
                                        <% reservation.order.order_products.paginate(:page => params[:page], per_page: 5).each do |order| %>
                                            <% product = Product.find(order.product_id) %>
                                            <tr class="text-center align-middle fw-bold">
                                                <td><%= image_tag(product.image(), :style => "width: 3.5em") %></td>
                                                <td><%= product.name %></td> 
                                                <td><%= product.price %> $</td>
                                            </tr> 
                                        <% end %>
                                    </tbody>
                                </table> 
                            </div>  

                            <div class="digg_pagination mb-1"> 
                                <div class="pull-right container">   
                                    <%= will_paginate reservation.order.order_products.paginate(:page => params[:page], per_page: 5), renderer: WillPaginate::ActionView::LinkRenderer  %>   
                                </div>
                            </div>    
                        <% end %>
                    </div> 
                </div>
            <% end %>  
        <% end %>  
    </div>  
</div> 
<%= render "shared/footer" %>


